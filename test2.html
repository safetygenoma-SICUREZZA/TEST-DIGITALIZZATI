<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 2 - Sicurezza Generale</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" style="display: flex; align-items: center;">
        <img src="logo CFL.png" alt="Logo CFL" class="cfl-logo">
      </div>
      <button onclick="window.location.href='test-selection.html'" class="btn-back btn-small">‚Üê Indietro</button>
    </header>

    <main class="test-page">
      <div class="test-header">
        <h2>Test 2 - Sicurezza Generale</h2>
        <p class="test-info">Massimo 1 errore consentito</p>
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
        <p class="progress-text" id="progressText">Domanda 1 di 8</p>
      </div>

      <div class="test-content">
        <div id="questionContainer"></div>
        <div class="navigation-buttons">
          <button id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()" style="display:none;">‚Üê Indietro</button>
          <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()">Avanti ‚Üí</button>
          <button id="submitBtn" class="btn btn-primary" onclick="submitTest()" style="display:none;">Invia Test</button>
        </div>
      </div>

      <div id="resultsContainer" style="display:none;">
        <div class="results-card">
          <h2>Risultati Test 2 - Sicurezza Generale</h2>
          <div class="score-circle"><div class="score-number" id="scoreDisplay"></div></div>
          <div id="resultDetails"></div>
          <div class="signature-section">
            <p><strong>COGNOME:</strong> <span id="resultCognome"></span></p>
            <p><strong>NOME:</strong> <span id="resultNome"></span></p>
            <p><strong>DATA:</strong> <span id="resultData"></span></p>
            <div class="signature-area" id="signatureArea" style="display:none;">
              <p><strong>FIRMA:</strong></p>
              <canvas id="signatureCanvas" width="400" height="150" style="border:1px solid #ccc;display:block;margin:10px 0;"></canvas>
              <button onclick="clearSignature()" class="btn btn-secondary btn-small">üóëÔ∏è Cancella Firma</button>
            </div>
          </div>
          <div class="result-buttons">
            <button id="signAndContinueBtn" class="btn btn-success btn-large" onclick="signAndContinue()" style="display:none;">‚úçÔ∏è Firma e Vai Avanti</button>
            <button id="retryBtn" class="btn btn-warning" onclick="retryWrongQuestions()" style="display:none;">üîÑ Ripeti Domande Sbagliate</button>
            <button onclick="window.location.href='test-selection.html'" class="btn btn-secondary">Torna alla Dashboard</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script defer src="script.js?v=12"></script>
  <script>
  const MAX_ERR_2 = 1;

  const questions = [
    {
      question: "La norma che ha riformato, riunito ed armonizzato, abrogando tutte le precedenti normative in materia di igiene e sicurezza nei luoghi di lavoro √®:",
      options: [
        "D.Lgs. 9 Aprile 2008 n¬∞81",
        "D.Lgs. 19 Settembre 1994 n¬∞626",
        "D.Lgs. 19 Agosto 2005 n¬∞187"
      ],
      correct: 0
    },
    {
      question: "Il Testo Unico disciplina:",
      options: [
        "I rapporti di lavoro subordinato",
        "La tutela sociale per i lavoratori",
        "La salute e la sicurezza sui luoghi di lavoro"
      ],
      correct: 2
    },
    {
      question: "Le disposizioni di cui al D.Lgs. n. 81/08 si applicano in tutti i settori di attivit√†, privati o pubblici, nei quali ci sono lavoratori subordinati o ad essi equiparati ed anche autonomi",
      options: ["Vero","Falso"],
      correct: 0
    },
    {
      question: "Il lavoratore deve prendersi cura della propria salute e sicurezza, conformemente alle istruzioni e formazioni fornitegli dal Datore di Lavoro",
      options: ["Vero","Falso"],
      correct: 0
    },
    {
      question: "Tra i doveri dei Lavoratori vi √® quello di segnalare tempestivamente eventuali deficienze delle attrezzature di lavoro, dei mezzi di protezione collettivi ed individuali:",
      options: ["Vero","Falso"],
      correct: 0
    },
    {
      question: "L‚Äôacronimo DPI significa:",
      options: [
        "Dispositivi Programmati di Intervento",
        "Dispositivi di Prevenzione Incendio",
        "Dispositivi di Protezione Individuale"
      ],
      correct: 2
    },
    {
      question: 'Cosa succede se premo questo pulsante situato a ridosso di un‚Äôattrezzatura di lavoro?<br><div style="display:flex; justify-content:center; align-items:center; width:100%;"><img src="immagini%20test%202/pulsante.jpg" alt="Pulsante di emergenza" style="max-width:150px; margin:10px 0; border:1px solid #ccc;"></div>',
      options: [
        "Viene attivata una sirena d‚Äôallarme",
        "Viene interrotta l‚Äôalimentazione della macchina la quale si blocca immediatamente",
        "Viene attivato il gruppo di continuit√†"
      ],
      correct: 1
    },
    {
      question: "I ripari, le protezioni ed i dispositivi di sicurezza di un‚Äôattrezzatura:",
      options: [
        "Possono essere rimossi o disattivati dal lavoratore a seconda delle esigenze di produzione.",
        "Possono essere rimossi o disattivati dal lavoratore solamente con la supervisione del preposto.",
        "Non possono in nessun caso essere rimossi o disattivati."
      ],
      correct: 2
    }
  ];

  let currentQuestion = 0;
  let answers = [];
  let questionsToShow = [];
  let originalIndexMap = [];
  let isRetry = false;
  let canvas, ctx, isDrawing = false, hasSignature = false;

  function initializeTest2(){
    const retryData = localStorage.getItem('test2_retry');
    if (retryData) {
      const wrongIdx = JSON.parse(retryData);
      questionsToShow = wrongIdx.map(i => questions[i]);
      originalIndexMap = wrongIdx.slice();
      isRetry = true;
      localStorage.removeItem('test2_retry');
      document.querySelector('.test-header h2').textContent = 'Test 2 - Ripetizione';
      document.querySelector('.test-info').textContent = 'Rispondi alle domande sbagliate';
      document.getElementById('progressText').textContent = `Domanda 1 di ${questionsToShow.length}`;
    } else {
      questionsToShow = [...questions];
      originalIndexMap = Array.from({length: questions.length}, (_,i)=>i);
    }
    currentQuestion = 0;
    answers = [];
  }

  function displayQuestion(){
    const q = questionsToShow[currentQuestion];
    let html = `<div class="question-card"><h3>${q.question}</h3><div class="options">`;
    q.options.forEach((opt,i)=>{
      html += `<label class="option-label"><input type="radio" name="q${currentQuestion}" value="${i}"><span class="option-text">${opt}</span></label>`;
    });
    html += `</div></div>`;
    document.getElementById("questionContainer").innerHTML = html;
    updateProgress(); updateButtons();
  }

  function saveAnswer(){
    const sel = document.querySelector(`input[name="q${currentQuestion}"]:checked`);
    answers[currentQuestion] = sel ? parseInt(sel.value) : null;
  }

  function nextQuestion(){ saveAnswer(); if(currentQuestion < questionsToShow.length - 1){ currentQuestion++; displayQuestion(); } }
  function previousQuestion(){ saveAnswer(); if(currentQuestion > 0){ currentQuestion--; displayQuestion(); } }

  function updateProgress(){
    const p = ((currentQuestion + 1) / questionsToShow.length) * 100;
    document.getElementById("progressBar").style.width = p + "%";
    document.getElementById("progressText").textContent = `Domanda ${currentQuestion + 1} di ${questionsToShow.length}`;
  }

  function updateButtons(){
    document.getElementById("prevBtn").style.display = currentQuestion > 0 ? "inline-block" : "none";
    document.getElementById("nextBtn").style.display = currentQuestion < questionsToShow.length - 1 ? "inline-block" : "none";
    document.getElementById("submitBtn").style.display = currentQuestion === questionsToShow.length - 1 ? "inline-block" : "none";
  }

  function submitTest(){
    saveAnswer();
    for(let i=0;i<questionsToShow.length;i++){
      if(answers[i]==null||Number.isNaN(answers[i])){
        alert("‚ö†Ô∏è Compila tutte le risposte prima di inviare."); return;
      }
    }
    let errors = 0, total = questionsToShow.length;
    const wrongOriginalIdx = [];
    questionsToShow.forEach((q,i)=>{
      if(answers[i] !== q.correct){
        errors++;
        wrongOriginalIdx.push(questions.indexOf(q));
      }
    });

    const correct = total - errors;
    const percentage = Math.round((correct/total)*100);
    const passed = errors <= MAX_ERR_2;
    const progress = JSON.parse(localStorage.getItem("testProgress")||"{}");
    progress.test2 = { errors, correct, total, percentage, passed, date: new Date().toISOString() };
    localStorage.setItem("testProgress", JSON.stringify(progress));

    const userData = JSON.parse(localStorage.getItem("userData")||"{}");
    document.querySelector(".test-content").style.display="none";
    document.querySelector(".test-header").style.display="none";
    document.getElementById("resultsContainer").style.display="block";
    document.getElementById("scoreDisplay").textContent = `${correct}/${total}`;
    document.getElementById("resultCognome").textContent = userData.cognome || "";
    document.getElementById("resultNome").textContent = userData.nome || "";
    document.getElementById("resultData").textContent = (new Date()).toLocaleDateString('it-IT');

    if(passed){
      localStorage.removeItem('test2_retry');
      document.getElementById("resultDetails").innerHTML =
        `<p class="result-percentage">Punteggio: ${percentage}%</p>
         <p class="result-status passed">‚úì TEST SUPERATO</p>
         <p class="error-count">Errori: ${errors}/${MAX_ERR_2}</p>
         <p class="success-message">Ottimo lavoro! Firma per procedere.</p>`;
      document.getElementById("signatureArea").style.display="block";
      document.getElementById("signAndContinueBtn").style.display="block";
      initializeSignatureCanvas();
    } else {
      localStorage.setItem('test2_retry', JSON.stringify(wrongOriginalIdx));
      document.getElementById("resultDetails").innerHTML =
        `<p class="result-percentage">Punteggio: ${percentage}%</p>
         <p class="result-status failed">‚úó TEST NON SUPERATO</p>
         <p class="error-count">Errori: ${errors}/${MAX_ERR_2}</p>
         <p class="retry-message">‚ö†Ô∏è Devi ripetere le domande sbagliate</p>`;
      document.getElementById("retryBtn").style.display="block";
    }
  }

  function retryWrongQuestions(){ window.location.reload(); }

  function initializeSignatureCanvas(){
    canvas=document.getElementById("signatureCanvas");
    if(!canvas)return;
    ctx=canvas.getContext("2d");
    ctx.strokeStyle="#000";ctx.lineWidth=2;ctx.lineCap="round";
    canvas.onmousedown=e=>{isDrawing=true;hasSignature=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);};
    canvas.onmousemove=e=>{if(!isDrawing)return;ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();};
    canvas.onmouseup=()=>isDrawing=false;canvas.onmouseout=()=>isDrawing=false;
    canvas.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches[0];const r=canvas.getBoundingClientRect();isDrawing=true;hasSignature=true;ctx.beginPath();ctx.moveTo(t.clientX-r.left,t.clientY-r.top);});
    canvas.addEventListener("touchmove",e=>{e.preventDefault();if(!isDrawing)return;const t=e.touches[0];const r=canvas.getBoundingClientRect();ctx.lineTo(t.clientX-r.left,t.clientY-r.top);ctx.stroke();});
    canvas.addEventListener("touchend",()=>isDrawing=false);
  }

  function clearSignature(){ctx.clearRect(0,0,canvas.width,canvas.height);hasSignature=false;}

  async function signAndContinue(){
    if(!hasSignature){ alert("‚ö†Ô∏è Per favore firma prima di continuare"); return; }

    const progress = JSON.parse(localStorage.getItem("testProgress")||"{}");
    progress.test2.signature = canvas.toDataURL("image/png");
    localStorage.setItem("testProgress", JSON.stringify(progress));

    const userData = JSON.parse(localStorage.getItem("userData")||"{}");
    const data = progress.test2 || {};

    const answers_raw = new Array(questions.length).fill(0);
    for (let i=0; i<questions.length; i++){
      answers_raw[i] = questions[i].correct;
    }
    for (let i=0; i<questionsToShow.length; i++){
      const origIdx = originalIndexMap[i];
      const sel = answers[i];
      if (sel != null && !Number.isNaN(sel)) answers_raw[origIdx] = sel;
    }

    const fullTotal = questions.length;
    const errorsFull = isRetry ? 0 : Math.max(0, fullTotal - (data.correct||0));
    const scoreFull = fullTotal - errorsFull;
    const percentageFull = Math.round((scoreFull / fullTotal) * 100);

    const payload = {
      userId: userData.userId||"",
      nome: userData.nome||"",
      cognome: userData.cognome||"",
      email: userData.email||"",
      telefono: userData.telefono||"",
      nomeTest: "Test 2_Sicurezza Generale",
      testId: "test2",
      score: scoreFull,
      total: fullTotal,
      percentuale: percentageFull,
      errors: errorsFull,
      stato: errorsFull <= 1 ? "Superato" : "Ripeti",
      data_test: (new Date()).toLocaleDateString('it-IT'),
      answers_raw: answers_raw,
      firma: canvas.toDataURL("image/png"),
      renderPdf: true
    };

    await window.sendTestDataToSheet(payload);
    window.location.href="test-selection.html";
  }

  initializeTest2();
  displayQuestion();
  </script>
</body>
</html>












